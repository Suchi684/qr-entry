<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BB Meet | Member Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container py-5">
    <div class="text-center mb-3">
      <a href="index.html" class="btn btn-outline-primary">Back to Main Dashboard</a>
    </div>

    <h2 class="text-center mb-4">Member List</h2>

    <div class="row justify-content-center mb-4">
      <div class="col-md-6 col-sm-12">
        <div class="input-group">
          <input type="text" id="newMemberName" class="form-control" placeholder="Enter new member name..." />
          <button class="btn btn-primary" onclick="addNewMember()">Add Member</button>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-6 mb-2">
        <input type="file" class="form-control" id="excelFile" />
      </div>
      <div class="col-md-3 mb-2">
        <button class="btn btn-success w-100" onclick="uploadExcel()">Import Excel</button>
      </div>
      <div class="col-md-3 mb-2">
        <button class="btn btn-info w-100" onclick="exportToExcel()">Export to Excel</button>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6 mx-auto">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by name..." />
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-hover table-striped text-center">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>QR Code</th>
            <th>Download</th>
            <th>QR Preview Link</th>
            <th>Entry</th>
            <th>Food</th>
            <th>Gift</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>



  <script>
    const API_BASE = "https://qr-entry-production.up.railway.app/api";
    let members = [];

    document.getElementById("searchInput").addEventListener("input", function () {
      const query = this.value.toLowerCase();
      const filtered = members.filter(m => m.name.toLowerCase().includes(query));
      renderTable(filtered);
    });

    async function loadMembers() {
      try {
        const response = await fetch(`${API_BASE}/members`);
        if (!response.ok) throw new Error("Failed to load members");
        members = await response.json();
        members.sort((a, b) => a.name.localeCompare(b.name));
        renderTable(members);
      } catch (error) {
        console.error(error);
        Swal.fire("Error", "Unable to load members from backend.", "error");
      }
    }

    async function addNewMember() {
      const nameInput = document.getElementById("newMemberName");
      const newName = nameInput.value.trim();
      if (!newName) {
        Swal.fire("Warning", "Please enter a member name.", "warning");
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/members`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: newName })
        });

        if (response.status === 409) {
          Swal.fire("Duplicate", "Member already exists.", "info");
          return;
        }
        if (!response.ok) {
          Swal.fire("Error", "Could not add member.", "error");
          return;
        }

        const member = await response.json();
        members.push(member);
        members.sort((a, b) => a.name.localeCompare(b.name));
        renderTable(members);
        nameInput.value = "";
        Swal.fire("Added", `${newName} has been added.`, "success");
      } catch (error) {
        console.error(error);
        Swal.fire("Error", "Could not add member.", "error");
      }
    }

    async function uploadExcel() {
      const file = document.getElementById("excelFile").files[0];
      if (!file) {
        Swal.fire("Warning", "Please choose an Excel file first.", "warning");
        return;
      }

      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        const names = rows
          .map(r => (r["Paid members"] || r["Name"] || "").toString().trim())
          .filter(Boolean);

        const response = await fetch(`${API_BASE}/members/import`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ names })
        });

        if (!response.ok) {
          Swal.fire("Error", "Import failed.", "error");
          return;
        }

        const result = await response.json();
        await loadMembers();
        Swal.fire("Imported", `Inserted: ${result.inserted}, Skipped: ${result.skipped}`, "success");
      } catch (error) {
        console.error(error);
        Swal.fire("Error", "Could not read/import this Excel file.", "error");
      }
    }

    function renderTable(data) {
      const table = document.getElementById("tableBody");
      table.innerHTML = "";

      data.forEach((m, i) => {
        const qrCanvas = document.createElement("canvas");
        QRCode.toCanvas(qrCanvas, m.name);

        const dlBtn = document.createElement("button");
        dlBtn.className = "btn btn-sm btn-primary";
        dlBtn.textContent = "Download";
        dlBtn.onclick = () => {
          const W = 600, H = 800;
          const offscreen = document.createElement("canvas");
          offscreen.width = W;
          offscreen.height = H;
          const ctx = offscreen.getContext("2d");

          const bg = new Image();
          bg.src = "img/meetup.jpg";

          bg.onload = () => {
            const scale = Math.max(W / bg.width, H / bg.height);
            const bw = bg.width * scale, bh = bg.height * scale;
            ctx.drawImage(bg, (W - bw) / 2, (H - bh) / 2, bw, bh);

            ctx.fillStyle = "rgba(0, 0, 0, 0.3)";
            ctx.fillRect(0, 0, W, H);

            ctx.textAlign = "center";
            ctx.fillStyle = "#ffd700";
            ctx.font = "bold 26px 'Segoe UI', sans-serif";
            ctx.shadowColor = "#ffcc00";
            ctx.shadowBlur = 12;
            ctx.fillText("WELCOME TO BB GRAND MEET 2026", W / 2, 60);
            ctx.shadowBlur = 0;

            ctx.fillStyle = "#ffffff";
            ctx.font = "bold 30px 'Segoe UI', sans-serif";
            ctx.fillText(m.name, W / 2, 130);

            const qrSize = 280;
            const qrX = (W - qrSize) / 2;
            const qrY = 170;

            ctx.fillStyle = "#ffffff";
            ctx.beginPath();
            ctx.roundRect(qrX - 15, qrY - 15, qrSize + 30, qrSize + 30, 15);
            ctx.fill();
            ctx.drawImage(qrCanvas, qrX, qrY, qrSize, qrSize);

            ctx.strokeStyle = "rgba(255, 215, 0, 0.6)";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(qrX - 15, qrY - 15, qrSize + 30, qrSize + 30, 15);
            ctx.stroke();

            ctx.fillStyle = "#ffd700";
            ctx.font = "16px 'Segoe UI', sans-serif";
            ctx.fillText("BB Meet | QR Pass", W / 2, qrY + qrSize + 60);

            ctx.fillStyle = "rgba(255,255,255,0.7)";
            ctx.font = "12px 'Segoe UI', sans-serif";
            ctx.fillText("Powered by Urbancode Edutech Solutions Pvt Ltd", W / 2, H - 30);

            const link = document.createElement("a");
            link.download = `${m.name.replace(/\s+/g, "_")}_QR_Pass.png`;
            link.href = offscreen.toDataURL();
            link.click();
          };
        };

        const shareBtn = document.createElement("button");
        shareBtn.className = "btn btn-sm btn-outline-secondary";
        shareBtn.textContent = "Copy QR Link";
        shareBtn.onclick = () => {
          const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
          const link = `${window.location.origin}${basePath}/preview.html?uid=${encodeURIComponent(m.id)}`;
          navigator.clipboard.writeText(link);
          Swal.fire("Copied", "QR preview link copied to clipboard.", "success");
        };

        const row = document.createElement("tr");
        row.innerHTML = `<td>${i + 1}</td><td>${m.name}</td>`;

        const qrCell = document.createElement("td");
        qrCell.appendChild(qrCanvas);
        row.appendChild(qrCell);

        const dlCell = document.createElement("td");
        dlCell.appendChild(dlBtn);
        row.appendChild(dlCell);

        const shareCell = document.createElement("td");
        shareCell.appendChild(shareBtn);
        row.appendChild(shareCell);

        ["entry", "food", "gift"].forEach(type => {
          const statusCell = document.createElement("td");
          statusCell.textContent = m.scan?.[type] ? "✅" : "❌";
          row.appendChild(statusCell);
        });

        table.appendChild(row);
      });
    }

    function exportToExcel() {
      const data = members.map((m, i) => ({
        SNo: i + 1,
        Name: m.name,
        Entry: m.scan?.entry ? "Yes" : "No",
        Food: m.scan?.food ? "Yes" : "No",
        Gift: m.scan?.gift ? "Yes" : "No"
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Members");
      XLSX.writeFile(wb, "BB_Meet_Members.xlsx");
    }

    window.onload = loadMembers;
  </script>

  <div class="text-center mt-5 mb-3 text-muted small">
    Powered by <a href="https://urbancode.in" class="text-decoration-none fw-semibold" target="_blank">Urbancode Edutech Solutions Private Limited</a>
  </div>
</body>
</html>
