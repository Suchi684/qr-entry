<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BB Meet | QR Pass</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      margin: 0;
      background: url('img/meetup.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Segoe UI', sans-serif;
      color: #fff3b0;
      overflow-x: hidden;
      text-align: center;
    }
  
    /* ‚ú® Logo Layout */
    .logos {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding-top: 20px;
      flex-wrap: wrap;
    }
  
    .bb-logo {
      height: 90px;
      width: auto;
      border-radius: 12px;
      box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 5px 15px rgba(0, 0, 0, 0.4);
      transform: scale(1.05);
      z-index: 1;
    }
  
    .urbancode-logo {
      height: 45px;
      opacity: 0.9;
      transform: translateY(10px);
      filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.2));
    }
  
    /* üëë Heading with Stage Glow */
    h2.welcome {
      font-size: 2.2rem;
      font-weight: 800;
      color: #ffd700;
      margin-top: 10px;
      margin-bottom: 20px;
      text-shadow: 1px 1px 2px #000, 0 0 8px #ffcc00, 0 0 12px #ffcc00;
      animation: flicker 2s infinite;
    }
  
    @keyframes flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.9; text-shadow: 0 0 10px #fff700; }
    }
  
    /* üéüÔ∏è Event Pass Container */
    .card-box {
      max-width: 520px;
      margin: 20px auto;
      background: linear-gradient(to bottom right, rgba(0, 0, 0, 0.5), rgba(55, 0, 0, 0.4));
      border-radius: 20px;
      padding: 40px 30px;
      border: 2px solid rgba(255, 215, 0, 0.6);
      box-shadow:
        0 4px 15px rgba(0, 0, 0, 0.5),
        0 0 30px rgba(255, 215, 0, 0.2),
        inset 0 0 20px rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(6px);
    }
  
    .attendee-name {
      font-size: 1.8rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 25px;
      text-shadow: 1px 1px 2px #000;
    }
  
    /* üéØ QR code area */
    canvas {
      border-radius: 15px;
      background: #fff;
      padding: 10px;
      margin-bottom: 20px;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
    }
  
    /* ‚ú® Golden Button */
    .btn-golden {
      background: linear-gradient(145deg, #ffd700, #ffae00);
      color: #2d0000;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      padding: 12px 30px;
      font-size: 16px;
      transition: 0.4s ease-in-out;
      box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
    }
  
    .btn-golden:hover {
      background: linear-gradient(145deg, #ffae00, #ffd700);
      box-shadow: 0 0 12px #ffcc00, 0 0 20px #ffd700;
      transform: translateY(-2px);
    }
  
    /* üßæ Footer CTA */
    .footer-cta {
      margin-top: 50px;
      font-size: 0.95rem;
      color: #222;
      background: rgba(255, 255, 255, 0.9);
      padding: 12px 25px;
      border-radius: 10px;
      display: inline-block;
      font-weight: 500;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
  
    .footer-cta a {
      color: #b8860b;
      font-weight: 600;
      text-decoration: none;
    }
  
    .footer-cta a:hover {
      text-decoration: underline;
      color: #ff8c00;
    }
  
    /* üåê Responsive */
    @media (max-width: 576px) {
      .logos {
        flex-direction: column;
        gap: 15px;
      }
  
      .attendee-name {
        font-size: 1.5rem;
      }
  
      .card-box {
        margin: 20px 15px;
      }
    }
  </style>
  
</head>

<body>

  <!-- üëë Logo Row -->
<div class="logos mb-2">
  <img src="img/bb.jpg" alt="BB Meet Logo" class="bb-logo" />
  <img src="img/logo.png" alt="Urbancode Logo" class="urbancode-logo" />
</div>

<h2 class="welcome">üéâ WELCOME TO BB GRAND MEET 2026 üéâ</h2>


  <!-- üî≤ QR Card -->
  <div class="card-box">
    <div class="attendee-name" id="qrName">Loading...</div>
    <canvas id="qrCanvas"></canvas>
    <button id="downloadBtn" class="btn btn-golden">‚¨áÔ∏è Download QR Pass</button>
  </div>

  <!-- üîó Footer -->
  <div class="footer-cta">
    Need a custom website or app for your business?<br>
    <a href="https://urbancode.in/projects/services.html" target="_blank">
      Contact Urbancode Edutech Solutions Pvt Ltd
    </a>
  </div>

  <script>

    const API_BASE = "https://qr-entry-production.up.railway.app/api";

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const uid = getQueryParam("uid");

    if (!uid) {
      document.getElementById("qrName").textContent = "No ID provided";
      Swal.fire("Error", "No member ID provided in the URL.", "error");
    } else {
      document.getElementById("qrName").textContent = "Loading...";

      fetch(`${API_BASE}/members/lookup?uid=${encodeURIComponent(uid)}`)
        .then(response => {
          if (response.status === 404) {
            throw new Error("NOT_FOUND");
          }
          if (!response.ok) throw new Error("FETCH_FAILED");
          return response.json();
        })
        .then(member => {
          document.getElementById("qrName").textContent = member.name;

          const canvas = document.getElementById("qrCanvas");
          QRCode.toCanvas(canvas, member.name, { width: 250 }, function (error) {
            if (error) {
              console.error(error);
              Swal.fire("Error", "Failed to generate QR code.", "error");
            }
          });

          document.getElementById("downloadBtn").onclick = function () {
            var btn = this;
            btn.disabled = true;

            var W = 600, H = 850;
            var offscreen = document.createElement("canvas");
            offscreen.width = W;
            offscreen.height = H;
            var ctx = offscreen.getContext("2d");

            function loadImg(src) {
              return new Promise(function (resolve, reject) {
                var img = new Image();
                img.onload = function () { resolve(img); };
                img.onerror = function () { reject(src); };
                img.src = src + "?v=" + Date.now();
              });
            }

            Promise.all([
              loadImg("img/meetup.jpg"),
              loadImg("img/bb.jpg"),
              loadImg("img/logo.png")
            ]).then(function (imgs) {
              var bg = imgs[0], bbLogo = imgs[1], ucLogo = imgs[2];

              // Draw background cover
              var scale = Math.max(W / bg.width, H / bg.height);
              var bw = bg.width * scale, bh = bg.height * scale;
              ctx.drawImage(bg, (W - bw) / 2, (H - bh) / 2, bw, bh);

              // Semi-transparent overlay
              ctx.fillStyle = "rgba(0, 0, 0, 0.25)";
              ctx.fillRect(0, 0, W, H);

              // BB Logo with white rounded background
              var bbH = 95;
              var bbW2 = (bbLogo.width / bbLogo.height) * bbH;
              var bbX = (W - bbW2) / 2;
              var bbY = 15;
              ctx.shadowColor = "rgba(0,0,0,0.4)";
              ctx.shadowBlur = 15;
              ctx.shadowOffsetY = 4;
              ctx.fillStyle = "#ffffff";
              ctx.beginPath();
              if (ctx.roundRect) { ctx.roundRect(bbX - 10, bbY - 10, bbW2 + 20, bbH + 20, 15); }
              else { ctx.rect(bbX - 10, bbY - 10, bbW2 + 20, bbH + 20); }
              ctx.fill();
              ctx.shadowBlur = 0; ctx.shadowOffsetY = 0;
              ctx.drawImage(bbLogo, bbX, bbY, bbW2, bbH);

              // Urbancode Logo (centered below BB)
              var ucH = 40;
              var ucW = (ucLogo.width / ucLogo.height) * ucH;
              ctx.drawImage(ucLogo, (W - ucW) / 2, 135, ucW, ucH);

              // Title line 1
              ctx.textAlign = "center";
              ctx.fillStyle = "#ffd700";
              ctx.font = "bold 36px 'Segoe UI', sans-serif";
              ctx.shadowColor = "#ffcc00";
              ctx.shadowBlur = 15;
              ctx.fillText("\uD83C\uDF89 WELCOME TO BB", W / 2, 225);
              // Title line 2
              ctx.fillText("GRAND MEET 2026 \uD83C\uDF89", W / 2, 268);
              ctx.shadowBlur = 0;

              // Card background
              var cardX = 40, cardY = 295, cardW = 520, cardH = 450;
              ctx.fillStyle = "rgba(55, 0, 0, 0.5)";
              ctx.beginPath();
              if (ctx.roundRect) { ctx.roundRect(cardX, cardY, cardW, cardH, 20); }
              else { ctx.rect(cardX, cardY, cardW, cardH); }
              ctx.fill();
              // Card gold border
              ctx.strokeStyle = "rgba(255, 215, 0, 0.6)";
              ctx.lineWidth = 2;
              ctx.beginPath();
              if (ctx.roundRect) { ctx.roundRect(cardX, cardY, cardW, cardH, 20); }
              else { ctx.rect(cardX, cardY, cardW, cardH); }
              ctx.stroke();

              // Attendee name inside card
              ctx.fillStyle = "#ffffff";
              ctx.font = "bold 28px 'Segoe UI', sans-serif";
              ctx.fillText(member.name, W / 2, cardY + 60);

              // QR code inside card
              var qr = document.getElementById("qrCanvas");
              var qrSize = 270;
              var qrX = (W - qrSize) / 2;
              var qrY = cardY + 105;

              // White rounded background for QR
              ctx.fillStyle = "#ffffff";
              ctx.beginPath();
              if (ctx.roundRect) { ctx.roundRect(qrX - 15, qrY - 15, qrSize + 30, qrSize + 30, 15); }
              else { ctx.rect(qrX - 15, qrY - 15, qrSize + 30, qrSize + 30); }
              ctx.fill();
              ctx.drawImage(qr, qrX, qrY, qrSize, qrSize);

              // Footer text
              ctx.fillStyle = "#ffd700";
              ctx.font = "16px 'Segoe UI', sans-serif";
              ctx.fillText("BB Meet | QR Pass", W / 2, cardY + cardH + 35);

              ctx.fillStyle = "rgba(255,255,255,0.7)";
              ctx.font = "12px 'Segoe UI', sans-serif";
              ctx.fillText("Powered by Urbancode Edutech Solutions Pvt Ltd", W / 2, H - 15);

              // Download
              var a = document.createElement("a");
              a.download = member.name.replace(/\s+/g, "_") + "_QR_Pass.png";
              a.href = offscreen.toDataURL("image/png");
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);

              btn.disabled = false;
              btn.textContent = "\u2B07\uFE0F Download QR Pass";
            }).catch(function (failedSrc) {
              console.error("Failed to load image:", failedSrc);
              Swal.fire("Error", "Could not load image: " + failedSrc, "error");
              btn.disabled = false;
              btn.textContent = "\u2B07\uFE0F Download QR Pass";
            });
          };
        })
        .catch(err => {
          console.error(err);
          document.getElementById("qrName").textContent = "Not Found";
          if (err.message === "NOT_FOUND") {
            Swal.fire("Error", "Member not found.", "error");
          } else {
            Swal.fire("Error", "Unable to verify member from backend.", "error");
          }
        });
    }
  </script>
</body>
</html>
